use crate::glyph::{GlyphEntry, Metrics};

{%- for font in fonts %}
    {%- for glyph in font.glyphs %}
static {{ glyph.codepoint }}_{{ font.name|upper }}: [u8; {{ glyph.bitmap_len }}] = [
    {%- for chunk in glyph.bitmap|batch(15) %}
    {% for column in chunk %}{{ column }}, {% endfor %}
    {%- endfor %}
];
    {%- endfor %}

pub static FONT_{{ font.name|upper }}: [(char, GlyphEntry); {{ font.glyphs|length }}] = [
    {%- for glyph in font.glyphs %}
    ('{{ glyph.character }}', GlyphEntry {
        glyph: &{{ glyph.codepoint }}_{{ font.name|upper }},
        px: {{ glyph.px }},
        metrics: Metrics {
            xmin: {{ glyph.metrics.xmin }},
            ymin: {{ glyph.metrics.ymin }},
            width: {{ glyph.metrics.width }},
            height: {{ glyph.metrics.height }},
            advance_width: {{ glyph.metrics.advance_width }},
        },
    }),
    {%- endfor %}
];
{%- endfor %}

#[derive(Clone, Copy, Default, PartialEq)]
pub enum VFontAlign {
    #[default] Top,
    Center,
    Baseline,
}

#[derive(Clone, Copy, Default, PartialEq)]
pub enum HFontAlign {
    #[default] Left,
    Center,
    Right,
}

#[derive(Clone, Copy, Default, PartialEq)]
pub enum Font {
    #[default]
    {%- for font in fonts %}
    {{ font.name|capitalize }}{{ "," if not loop.last }}
    {%- endfor %}
}

impl Font {
    /// # get_glyphs
    ///
    /// Returns the static array of glyphs of the font on which is called.
    pub fn get_glyph(&self, ch: char) -> Option<&GlyphEntry> {
        match self {
            {%- for font in fonts %}
            Font::{{ font.name|capitalize }} => Self::find_glyph(&FONT_{{ font.name|upper }}, ch),
            {%- endfor %}
        }
    }

    /// # get_size
    ///
    /// Returns the size of the generated font (the one decided by the user).
    pub fn get_size(&self) -> i32 {
        match self {
            {%- for font in fonts %}
            Font::{{ font.name|capitalize }} => {{ font.glyphs[0].px }},
            {%- endfor %}
        }
    }

    pub fn get_ascent(&self) -> i32 {
        match self {
            {%- for font in fonts %}
            Font::{{ font.name|capitalize }} => {{ font.ascent }},
            {%- endfor %}
        }
    }

    pub fn get_descent(&self) -> i32 {
        match self {
            {%- for font in fonts %}
            Font::{{ font.name|capitalize }} => {{ font.descent }},
            {%- endfor %}
        }
    }


    fn find_glyph(font: &[(char, GlyphEntry)], ch: char) -> Option<&GlyphEntry> {
        font.binary_search_by_key(&ch, |&(c, _)| c)
            .ok()
            .map(|idx| &font[idx].1)
    }
}
